* Routine to receive input data from the Web and produce "METADATA" in return.

ORIG.CITY  = ''
ORIG.STATE = ''

DEST.CITY  = ''
DEST.STATE = ''

SERVICE.LVL.ARRAY= ""

SERVICE.LVL.ARRAY<1,1>  = "First Overnight"
SERVICE.LVL.ARRAY<2,1>  = "Priority Overnight"
SERVICE.LVL.ARRAY<3,1> = "Standard Overnight"
SERVICE.LVL.ARRAY<4,1>  = "2 Day"
SERVICE.LVL.ARRAY<5,1>  = "Express Saver"
SERVICE.LVL.ARRAY<6,1>  = "Ground Commercial"
SERVICE.LVL.ARRAY<7,1>  = "Home Delivery"

SERVICE.LVL.ARRAY<1,2>  = "1STON"
SERVICE.LVL.ARRAY<2,2>  = "PRIO_ON"
SERVICE.LVL.ARRAY<3,2> = "STD_ON"
SERVICE.LVL.ARRAY<4,2>  = "2DAY"
SERVICE.LVL.ARRAY<5,2>  = "EXP_SVER"
SERVICE.LVL.ARRAY<6,2>  = "GR_COMM"
SERVICE.LVL.ARRAY<7,2>  = "HOME_DEL"

CALL GET.USER(USER)


IF USER = "NPRATT" THEN
*   ORIG.ZIP = '01301'
*   DEST.ZIP = '01001'
*   EFF.DATE   = '07/10/09'
*   WEIGHT = '903'
   ORIG.ZIP = '76107'
   DEST.ZIP = '75229'
*   DEST.ZIP = '71111'
   EFF.DATE   = OCONV(DATE(),"D2/")
   WEIGHT = '10'
   RESIDENTIAL.FLAG = "Y"
   LET.PARCEL = "P"
   DATA ORIG.ZIP
   DATA DEST.ZIP
   DATA EFF.DATE
   DATA WEIGHT
   DATA RESIDENTIAL.FLAG
   DATA LET.PARCEL
END

***  INPUTS 

INPUT ORIG.ZIP
INPUT DEST.ZIP
INPUT EFF.DATE
INPUT WEIGHT
INPUT RESIDENTIAL.FLAG
INPUT LET.PARCEL

IN.WEIGHT = WEIGHT

I.EFF.DATE = ICONV(EFF.DATE,"D2/")
D.ZONE = ""
*
WEIGHT = ICONV(WEIGHT,"MR2")
WEIGHT = OCONV(WEIGHT,"MR2")

*** XXX IF FIELD(WEIGHT,".",2) NE "0" THEN WEIGHT = INT(WEIGHT) + 1 ELSE WEIGHT = WEIGHT

OPEN '','VOC' TO F.NP.TEST THEN
   TST.REC = ORIG.ZIP
   TST.REC<2> = DEST.ZIP
   TST.REC<3> = EFF.DATE
   TST.REC<4> = IN.WEIGHT
   TST.REC<5> = RESIDENTIAL.FLAG
   TST.REC<6> = LET.PARCEL
   TST.REC<7> = WEIGHT
   TST.REC<10> = OCONV(DATE(),"D2/"):" ":OCONV(TIME(),"MTS")
   WRITE TST.REC ON F.NP.TEST, "FEDEX.RATER.INPUT"
END

DETAIL.ARRAY = ''

N.SVL = DCOUNT(SERVICE.LVL.ARRAY,@AM)

FOR SRVC.CNT = 1 TO N.SVL
   RATE.EFF.DATE = I.EFF.DATE

   SERVICE.LVL = SERVICE.LVL.ARRAY<SRVC.CNT,2>

   ID.CARRIER = "00015"  ;* Federal Express Corporation

   IF SERVICE.LVL = "GR_COMM" OR SERVICE.LVL = "HOME_DEL" THEN
      ID.CARRIER = "01075"
   END

   ID.IDX = ID.CARRIER
*
   GOSUB CALC.RATE

NEXT SRVC.CNT


GOSUB DO.META

STOP

*
CALC.RATE :

DEBUG.FLAG = 0    ;* SET TO 1 FOR DEBUGGING PURPOSES
*
VOUT = ""

VIN    = ORIG.ZIP
VIN<2> = DEST.ZIP
VIN<3> = I.EFF.DATE
VIN<4> = WEIGHT
VIN<5> = RATE.EFF.DATE
VIN<6> = SERVICE.LVL
VIN<7> = ID.CARRIER
VIN<8> = RESIDENTIAL.FLAG
VIN<9> = LET.PARCEL

IF DEBUG.FLAG THEN
   CRT @(-1)
   CRT "FEDEX.RATER GOING TO  CALC.CARRIER.RATE" ; CRT
   CRT "VIN   ":VIN
   CRT; CRT
   CRT "VOUT  ":VOUT
   CALL ELINE("")
END

CALL CALC.CARRIER.RATE(VIN,VOUT,SERVICE.LVL.ARRAY,ERRORS)

IF DEBUG.FLAG THEN
   CRT @(-1)
   CRT "FEDEX.RATER  COMING FROM CALC.CARRIER.RATE" ; CRT
   CRT "VIN   ":VIN
   CRT; CRT
   CRT "VOUT  ":VOUT
   CALL ELINE("")
END

*
IF ERRORS NE "" THEN
   ERR.LINE = ERRORS
   CONVERT @VM TO " " IN ERR.LINE
* CRT ERRORS ; INPUT QQ
*   CALL ELINE(ERR.LINE)
*   RETURN
END

IF D.ZONE = "" THEN D.ZONE     = VOUT<1>
D.RATE     = VOUT<2> * 1
D.FSC.PERC = VOUT<3> * 1
D.FSC.AMT  = VOUT<4> * 1
D.TOT.AMT  = VOUT<5> * 1

IF ORIG.CITY  = "" THEN ORIG.CITY  = VOUT<6>
IF ORIG.STATE = "" THEN ORIG.STATE = VOUT<7>

IF DEST.CITY  = "" THEN DEST.CITY  = VOUT<8>
IF DEST.STATE = "" THEN DEST.STATE = VOUT<9>

D.ADD.CHARGE = VOUT<10>

DETAIL.ARRAY<1,-1> = D.ZONE
DETAIL.ARRAY<2,-1> = D.RATE
DETAIL.ARRAY<3,-1> = D.FSC.PERC
DETAIL.ARRAY<4,-1> = D.FSC.AMT
DETAIL.ARRAY<5,-1> = D.TOT.AMT
DETAIL.ARRAY<6,-1> = D.ADD.CHARGE

RETURN

DO.META :

      METADATA = ""
      METADATA<1, 1> = "VARCHAR" ; METADATA<1, 2> = "Errors"          ; METADATA<1 ,3> = 0

      METADATA<2 ,1> = "VARCHAR" ; METADATA<2, 2> = "OrigZip"         ; METADATA<2 ,3> = 0
      METADATA<3 ,1> = "VARCHAR" ; METADATA<3, 2> = "OrigCity"        ; METADATA<3 ,3> = 0
      METADATA<4 ,1> = "VARCHAR" ; METADATA<4, 2> = "OrigState"       ; METADATA<4 ,3> = 0
      METADATA<5 ,1> = "VARCHAR" ; METADATA<5, 2> = "DestZip"         ; METADATA<5 ,3> = 0
      METADATA<6 ,1> = "VARCHAR" ; METADATA<6, 2> = "DestCity"        ; METADATA<6 ,3> = 0
      METADATA<7 ,1> = "VARCHAR" ; METADATA<7, 2> = "DestState"       ; METADATA<7 ,3> = 0
      METADATA<8 ,1> = "VARCHAR" ; METADATA<8, 2> = "Zone"            ; METADATA<8 ,3> = 0
      METADATA<9 ,1> = "VARCHAR" ; METADATA<9, 2> = "Residential"     ; METADATA<9 ,3> = 0
      METADATA<10,1> = "VARCHAR" ; METADATA<10,2> = "Package Type"    ; METADATA<10,3> = 0

      DD.POS = 11

      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl1Desc"    ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl1Tot"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl1Amt"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl1FscPerc" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl1FscAmt"  ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl1AddChrg" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1

      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl2Desc"    ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl2Tot"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl2Amt"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl2FscPerc" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl2FscAmt"  ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl2AddChrg" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1

      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl3Desc"    ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl3Tot"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl3Amt"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl3FscPerc" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl3FscAmt"  ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl3AddChrg" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1

      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl4Desc"    ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl4Tot"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl4Amt"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl4FscPerc" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl4FscAmt"  ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl4AddChrg" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1

      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl5Desc"    ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl5Tot"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl5Amt"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl5FscPerc" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl5FscAmt"  ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl5AddChrg" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1

      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl6Desc"    ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl6Tot"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl6Amt"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl6FscPerc" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl6FscAmt"  ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl6AddChrg" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1

      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl7Desc"    ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl7Tot"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl7Amt"     ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl7FscPerc" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl7FscAmt"  ; METADATA<DD.POS,3> = 0   ; DD.POS += 1
      METADATA<DD.POS,1> = "VARCHAR" ; METADATA<DD.POS,2> = "SrvcLvl7AddChrg" ; METADATA<DD.POS,3> = 0   ; DD.POS += 1

************* Set up data to be sent

      ROW = ERRORS

      ROW<2 ,1> = ORIG.ZIP
      ROW<3 ,1> = ORIG.CITY
      ROW<4 ,1> = ORIG.STATE
      ROW<5 ,1> = DEST.ZIP
      ROW<6 ,1> = DEST.CITY
      ROW<7 ,1> = DEST.STATE
      ROW<8 ,1> = D.ZONE
      ROW<9 ,1> = RESIDENTIAL.FLAG
      ROW<10,1> = LET.PARCEL

      ROW.CNT = 11

FOR I.DET = 1 TO 7
   D.ZONE     = DETAIL.ARRAY<1,I.DET>
   D.RATE     = DETAIL.ARRAY<2,I.DET> * 1
   D.FSC.PERC = DETAIL.ARRAY<3,I.DET> * 1
   D.FSC.AMT  = DETAIL.ARRAY<4,I.DET> * 1
   D.TOT.AMT  = DETAIL.ARRAY<5,I.DET> * 1
   D.ADD.CHRG = DETAIL.ARRAY<6,I.DET> * 1

   ROW<ROW.CNT> = SERVICE.LVL.ARRAY<I.DET,1>
   ROW.CNT += 1
   ROW<ROW.CNT> = OCONV(D.TOT.AMT,"MR2,")
   ROW.CNT += 1
   ROW<ROW.CNT> = OCONV(D.RATE,"MR2,")
   ROW.CNT += 1
   ROW<ROW.CNT> = OCONV(D.FSC.PERC,"MR2")
   ROW.CNT += 1
   ROW<ROW.CNT> = OCONV(D.FSC.AMT,"MR2,")
   ROW.CNT += 1
   ROW<ROW.CNT> = OCONV(D.ADD.CHRG,"MR2,")
   ROW.CNT += 1
NEXT I.DET

* CRT \"METADATA" PASSED  BACK ....\  ; CRT

*N.M = DCOUNT(METADATA,@AM)
*FOR X = 1 TO N.M
*   CRT METADATA<X,1> "L#25":" ":
*   CRT METADATA<X,2> "L#25":" ":
*   CRT METADATA<X,3> "R#5"  
*NEXT N.M

* CRT "DATA PASSED  BACK ...."  ; CRT

*N.M = DCOUNT(ROW,@AM)
*FOR X = 1 TO N.M
*   CRT ROW<X> "R#25"  
*NEXT N.M

* CALL ELINE("")

CONVERT @AM TO CHAR(30) IN METADATA
PRINT "%METADATA:":METADATA

*CRT ; CRT STR("*",80) ; CRT

CONVERT @AM TO CHAR(30) IN ROW
CRT ROW


RETURN
